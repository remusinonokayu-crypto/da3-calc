<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<title>採取・採掘アイテム統計管理（IndexedDB版）</title>

<style>
  body {
    font-family: sans-serif;
    padding: 20px;
    transition: background 0.2s, color 0.2s;
  }

  /* ライトテーマ */
  body.light {
    background: #ffffff;
    color: #000000;
  }
  body.light .box {
    background: #f9f9f9;
    border: 1px solid #ccc;
  }

  /* ダークテーマ */
  body.dark {
    background: #1e1e1e;
    color: #dddddd;
  }
  body.dark .box {
    background: #2c2c2c;
    border: 1px solid #555;
  }

  .box {
    padding: 15px;
    margin-bottom: 20px;
    border-radius: 8px;
  }

  label {
    display: block;
    margin-top: 10px;
  }

  table {
    border-collapse: collapse;
    width: 100%;
    margin-top: 10px;
  }

  th, td {
    border: 1px solid #888;
    padding: 5px;
    text-align: center;
  }

  button {
    margin-top: 10px;
    padding: 6px 12px;
    cursor: pointer;
  }

  body.dark button {
    background: #444;
    color: #fff;
    border: 1px solid #666;
  }
  body.light button {
    background: #eee;
    color: #000;
    border: 1px solid #ccc;
  }

  /* スマホ対応 */
  @media (max-width: 600px) {
    body {
      padding: 10px;
      font-size: 0.95em;
    }
    h1 { font-size: 1.4em; }
    .box { padding: 12px; }

    select, button {
      width: 100%;
      margin-top: 10px;
      padding: 10px;
    }

    #itemInputs div { margin-bottom: 8px; }
    #itemInputs input[type="number"] {
      width: 100%;
      margin-top: 5px;
    }

    .table-wrapper {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    table { min-width: 600px; }
  }
</style>

<!-- Dexie.js -->
<script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>
</head>

<body class="light">

<h1>採取・採掘アイテム統計管理（IndexedDB版）</h1>
<button onclick="location.href='IndexedDB.html'">新データ保存方式ホームへ移動</button>
<!-- テーマ切り替え -->
<div class="box">
  <label>
    テーマ切り替え：
    <select id="themeSelect" onchange="changeTheme()">
      <option value="light">ライト</option>
      <option value="dark">ダーク</option>
    </select>
  </label>
</div>

<!-- 保存件数の表示（上限なし） -->
<div class="box">
  <h2>履歴情報</h2>
  <div id="currentLimitView" style="margin-top:10px; font-weight:bold;">
    現在の保存数：0件
  </div>
</div>

<div class="box">
  <label>カテゴリ：
    <select id="categorySelect" onchange="loadCategory()">
      <option value="gather">採取</option>
      <option value="mine">採掘</option>
    </select>
  </label>

  <label>町の選択：
    <select id="townSelect" onchange="loadTown()"></select>
  </label>

  <button onclick="showAllTownSummary()">全町まとめ</button>
</div>

<div class="box">
  <h2>取得アイテム入力(1C分想定)</h2>
  <div id="itemInputs"></div>
  <button onclick="saveData()">保存</button>
  <button onclick="undo()">ひとつ前に戻す</button>
  <button onclick="redo()">戻した履歴を復元</button>
</div>

<div class="box">
  <h2>統計結果</h2>
  <div class="table-wrapper">
    <div id="stats"></div>
  </div>
</div>

<div class="box">
  <h2>全町統合まとめ</h2>
  <div class="table-wrapper">
    <div id="allTownSummary"></div>
  </div>
</div>

<div class="box">
  <h2>履歴管理</h2>
  <button onclick="clearAll()">全履歴削除</button>
</div>

<script>
/* ===========================
   データセット（元のまま）
=========================== */
const dataSet = {
  gather: {
    "レポロ村（苗木）": [
      "木の枝",
      "柔らかい木",
      "大きな葉っぱ",
      "蜂の巣",
      "蜂の巣のかけら",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "レポロ村（綿）": [
      "コットン",
      "魔法石レベル1",
      "魔法石レベル2",
       "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "マクルダ町（苗木）": [
      "大樹の丸太",
      "天然樹液",
      "大きな葉っぱ",
      "木の枝",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1",
      "樹齢1000年越えの世界樹の一部"
    ],
    "ルーチェア町（苗木）": [
      "木の枝",
      "大きな葉っぱ",
      "天然樹液",
      "魔法の樹木",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1",
      "樹齢1000年越えの世界樹の一部"
    ],
    "ソルソロ王国（苗木）": [
      "木の枝",
      "大きな葉っぱ",
      "魔法の樹木",
      "謎の化石",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1",
      "樹齢1000年越えの世界樹の一部"
    ],
    "ソルソロ王国 セルバ農園（畑）": [
      "調理用薬草",
      "小麦",
      "じゃがいも",
      "ニンジン",
      "ビートルート",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "サプネラ王国（苗木）": [
      "輝く砂",
      "砂の結晶",
      "砂漠の涙",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "セシド町（採取）": [
      "綺麗な果実",
      "泥まみれの骨",
      "魔法石lv1",
      "魔法石lv2",
      "魔法石lv3",
      "グロースクリスタルレベル1"
    ]
  },

  mine: {
    "レポロ村（採掘）": [
      "石",
      "頑丈な石",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "マクルダ町（採掘）": [
      "石",
      "頑丈な石",
      "鉛",
      "鉄",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "ルーチェア町（採掘）": [
      "石",
      "頑丈な石",
      "鉛",
      "鉄",
      "魔石の破片",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "ソルソロ王国（平原）": [
      "金",
      "鋼の粉",
      "サルファー原石",
      "石",
      "頑丈な石",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "ソルソロ王国（砂漠）": [
      "金",
      "赤褐色の鉱物",
      "サルファー原石",
      "石",
      "頑丈な石",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1"
    ],
    "デイリーダンジョン": [
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1",
      "グロースクリスタルレベル2",
      "グロースクリスタルレベル3"
    ],
    "サプネラ王国（採掘）": [
      "赤い鉱石",
      "サルファー原石",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルレベル1",
      "エビルナイト原石"
    ],
    "セシド町（採掘）": [
      "風化した化石",
      "紫の水晶",
      "魔法石レベル1",
      "魔法石レベル2",
      "魔法石レベル3",
      "グロースクリスタルlv1",
      "夢見の勾玉"
    ]
  }
};


//////////////////////////////
// IndexedDB 初期化（Dexie）
//////////////////////////////
const db = new Dexie("GatherDB_v1");
db.version(1).stores({
  townData: "&key",   // key = mode || '||' || town  (unique)
  settings: "&key"    // key = 'theme' など
});

/* ===========================
   ヘルパー：DBアクセス
   - key 生成: mode + '||' + town
   - getTownData / putTownData / removeTownData
=========================== */
function makeKey(mode, town) {
  return `${mode}||${town}`;
}

async function getTownData(mode, town) {
  const key = makeKey(mode, town);
  const row = await db.townData.get(key);
  if (!row) {
    // 初期構造
    return { records: [], undo: [] };
  }
  return row.data;
}

async function putTownData(mode, town, data) {
  const key = makeKey(mode, town);
  await db.townData.put({ key, data });
}

async function removeTownData(mode, town) {
  const key = makeKey(mode, town);
  await db.townData.delete(key);
}

async function getSetting(key) {
  const row = await db.settings.get(key);
  return row ? row.value : null;
}
async function putSetting(key, value) {
  await db.settings.put({ key, value });
}

//////////////////////////////
// テーマ（ダーク/ライト）管理（settings を使用）
//////////////////////////////
async function initTheme() {
  const savedTheme = await getSetting("theme_mode");
  const theme = savedTheme || "light";
  document.body.className = theme;
  document.getElementById("themeSelect").value = theme;

  document.getElementById("themeSelect").addEventListener("change", async () => {
    const t = document.getElementById("themeSelect").value;
    document.body.className = t;
    await putSetting("theme_mode", t);
  });
}

//////////////////////////////
// UI: 履歴件数のみ表示
//////////////////////////////
async function showHistoryLimit() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;
  if (!town) {
    document.getElementById("currentLimitView").textContent = `現在の保存数：0件`;
    return;
  }
  const data = await getTownData(mode, town);
  const count = data.records ? data.records.length : 0;
  document.getElementById("currentLimitView").textContent = `現在の保存数：${count}件`;
}

/* ===========================
   カテゴリ変更
=========================== */
function loadCategory() {
  const mode = document.getElementById("categorySelect").value;
  const sel = document.getElementById("townSelect");

  sel.innerHTML = "";
  Object.keys(dataSet[mode]).forEach(town => {
    const opt = document.createElement("option");
    opt.value = town;
    opt.textContent = town;
    sel.appendChild(opt);
  });

  loadTown();
}


/* ===========================
   町変更
   -> アイテム入力欄を描画
   -> 履歴件数を表示
=========================== */
async function loadTown() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;

  const items = dataSet[mode][town];
  const box = document.getElementById("itemInputs");
  box.innerHTML = "";

  items.forEach(name => {
    const div = document.createElement("div");
    div.innerHTML = `${name}<br><input type="number" id="input_${encodeURIComponent(name)}" min="0" value="0">`;
    box.appendChild(div);
  });

  await showStats();
  await showHistoryLimit();
}


/* ===========================
   データ保存（IndexedDB：無制限）
   - records / undo 構造は維持
=========================== */
async function saveData() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;
  const items = dataSet[mode][town];

  // 取得中の既存データ
  let data = await getTownData(mode, town);
  if (!data.records) data.records = [];
  if (!data.undo) data.undo = [];

  // 新規レコード作成
  const record = {};
  items.forEach(name => {
    const el = document.getElementById("input_" + encodeURIComponent(name));
    const v = el ? Number(el.value) : 0;
    record[name] = v;
  });

  // 無制限に push
  data.records.push(record);

  // undo バッファクリア
  data.undo = [];

  // DB に保存
  try {
    await putTownData(mode, town, data);
    await showStats();
    await showHistoryLimit();
    alert("保存しました（IndexedDB）");
  } catch (e) {
    console.error("保存エラー:", e);
    alert("保存に失敗しました: " + (e.message || e));
  }
}


/* ===========================
   Undo
=========================== */
async function undo() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;

  let data = await getTownData(mode, town);
  if (!data.records || data.records.length === 0) return;

  const removed = data.records.pop();
  if (!data.undo) data.undo = [];
  data.undo.push(removed);

  await putTownData(mode, town, data);
  await showStats();
  await showHistoryLimit();
}


/* ===========================
   Redo
=========================== */
async function redo() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;

  let data = await getTownData(mode, town);
  if (!data.undo || data.undo.length === 0) return;

  const rec = data.undo.pop();
  data.records.push(rec);

  await putTownData(mode, town, data);
  await showStats();
  await showHistoryLimit();
}


/* ===========================
   全履歴削除
=========================== */
async function clearAll() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;

  const ok = confirm("本当にこの町の全履歴を削除しますか？");
  if (!ok) return;

  await removeTownData(mode, town);
  // 初期化した空データを DB に入れておく（UIが空配列で動くように）
  await putTownData(mode, town, { records: [], undo: [] });

  await showStats();
  await showHistoryLimit();
}


/* ===========================
   町別統計
=========================== */
async function showStats() {
  const mode = document.getElementById("categorySelect").value;
  const town = document.getElementById("townSelect").value;
  const items = dataSet[mode][town];

  const data = await getTownData(mode, town);

  if (!data.records || data.records.length === 0) {
    document.getElementById("stats").innerHTML = "まだデータがありません";
    return;
  }

  const count = data.records.length;

  const sum = {}, max = {}, min = {};
  items.forEach(i => {
    sum[i] = 0;
    max[i] = 0;
    min[i] = Infinity;
  });

  data.records.forEach(rec => {
    items.forEach(i => {
      const v = rec[i] || 0;
      sum[i] += v;
      if (v > max[i]) max[i] = v;
      if (v < min[i]) min[i] = v;
    });
  });

  let totalItems = 0;
  items.forEach(i => totalItems += sum[i]);

  let html = `<table><tr>
    <th>アイテム</th>
    <th>平均</th>
    <th>最大</th>
    <th>最小</th>
    <th>取得確率</th>
    <th>入力回数</th>
  </tr>`;

  items.forEach(name => {
    const avg = (sum[name] / count).toFixed(2);
    const prob = totalItems > 0 ? ((sum[name] / totalItems) * 100).toFixed(2) + "%" : "0%";

    html += `
    <tr>
      <td>${name}</td>
      <td>${avg}</td>
      <td>${max[name]}</td>
      <td>${min[name] === Infinity ? 0 : min[name]}</td>
      <td>${prob}</td>
      <td>${count}</td>
    </tr>`;
  });

  html += `</table>`;
  document.getElementById("stats").innerHTML = html;
}


/* ===========================
   全町統合まとめ
=========================== */
async function showAllTownSummary() {
  const mode = document.getElementById("categorySelect").value;
  const towns = Object.keys(dataSet[mode]);

  let globalTotals = {};
  let globalSum = 0;

  // 先にグローバル合計を計算
  for (const town of towns) {
    const data = await getTownData(mode, town);
    if (!data.records) continue;

    const items = dataSet[mode][town];
    const sum = {};
    items.forEach(i => sum[i] = 0);

    data.records.forEach(rec => {
      items.forEach(i => sum[i] += (rec[i] || 0));
    });

    items.forEach(i => {
      if (!globalTotals[i]) globalTotals[i] = 0;
      globalTotals[i] += sum[i];
      globalSum += sum[i];
    });
  }

  let html = "";

  for (const town of towns) {
    const data = await getTownData(mode, town);
    const items = dataSet[mode][town];

    html += `<h3>${town}</h3>`;

    if (!data.records || data.records.length === 0) {
      html += `<p>まだデータがありません。</p>`;
      continue;
    }

    const count = data.records.length;
    const sum = {}, max = {}, min = {};
    items.forEach(i => {
      sum[i] = 0;
      max[i] = 0;
      min[i] = Infinity;
    });

    data.records.forEach(rec => {
      items.forEach(i => {
        const v = rec[i] || 0;
        sum[i] += v;
        if (v > max[i]) max[i] = v;
        if (v < min[i]) min[i] = v;
      });
    });

    let townTotal = 0;
    items.forEach(i => townTotal += sum[i]);

    html += `<table>
      <tr>
        <th>アイテム</th>
        <th>平均</th>
        <th>最大</th>
        <th>最小</th>
        <th>町内確率</th>
        <th>カテゴリ確率</th>
        <th>入力回数</th>
      </tr>
    `;

    items.forEach(i => {
      const avg = (sum[i] / count).toFixed(2);
      const probTown = townTotal > 0 ? ((sum[i] / townTotal) * 100).toFixed(2) + "%" : "0%";
      const probGlobal = globalSum > 0 ? ((globalTotals[i] / globalSum) * 100).toFixed(2) + "%" : "0%";

      html += `
      <tr>
        <td>${i}</td>
        <td>${avg}</td>
        <td>${max[i]}</td>
        <td>${min[i] === Infinity ? 0 : min[i]}</td>
        <td>${probTown}</td>
        <td>${probGlobal}</td>
        <td>${count}</td>
      </tr>`;
    });

    html += `</table><br>`;
  }

  document.getElementById("allTownSummary").innerHTML = html;
}


/* 初期ロード */
(async function init() {
  // 初期 DB レコードが無くても動くように（テーブルは既に定義済み）
  await initTheme();         // テーマ読込（settings）
  await loadCategory();      // カテゴリと町を描画 -> loadTown が呼ばれる
})();
</script>

</body>
</html>
