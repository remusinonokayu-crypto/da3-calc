<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DA3 経験値計算機</title>

<!-- PWA：manifest 読み込み -->
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<meta name="theme-color" content="#007bff">

<style>
body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 15px;
    background: #f4f4f4;
}

label {
    margin-top: 12px;
    font-size: 16px;
    font-weight: bold;
    display: block;
}

select, input, button {
    width: 100%;
    font-size: 18px;
    padding: 12px;
    margin-top: 5px;
    box-sizing: border-box;
}

button {
    margin-top: 18px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    padding: 14px;
}
button:hover {
    background: #005fcc;
}

h1, h2 {
    margin-top: 25px;
    text-align: center;
}

/* テーブルスマホ対応 */
.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 10px;
    background: white;
    border-radius: 5px;
}

table {
    border-collapse: collapse;
    width: 100%;
    min-width: 600px;
    margin-top: 15px;
}
table, th, td {
    border: 1px solid #aaa;
}
th, td {
    padding: 6px;
    text-align: center;
}

@media (max-width: 600px) {
    body { padding: 10px; }
    h1 { font-size: 22px; }
    h2 { font-size: 20px; }
    select, input, button {
        font-size: 16px;
        padding: 10px;
    }
    label { font-size: 15px; }
}
</style>
</head>

<body>

<h1>DA3 経験値計算機</h1>

<!-- 戦闘職 -->
<h2>戦闘職計算</h2>

<label>職業：</label>
<select id="job">
    <option value="special">特殊</option>
    <option value="first">一次</option>
    <option value="second">二次</option>
    <option value="third">三次</option>
</select>

<label>開始レベル：</label>
<input type="number" id="lvStart" min="1" value="1">

<label>終了レベル：</label>
<input type="number" id="lvEnd" min="1" value="1">

<label>納品EXP（1回あたり）：</label>
<input type="number" id="gain" min="1" value="1">

<label>1回の納品で使う必要個数：</label>
<input type="number" id="itemPerDelivery" min="1" value="1">

<label>1分間に取れる素材量：</label>
<input type="number" id="perMinute" min="0" value="10">

<button onclick="calcTotal()">戦闘職を計算する</button>

<div id="summary" style="margin-top:15px; font-size:18px;"></div>
<div class="table-wrapper"><div id="result"></div></div>

<hr>

<!-- 生産職 -->
<h2>生産職計算</h2>

<label>生産職：</label>
<select id="prodJob">
    <option value="weapon">武器</option>
    <option value="armor">防具</option>
    <option value="tool">道具</option>
    <option value="alchemy">錬金</option>
    <option value="mining">採掘</option>
    <option value="gathering">採取</option>
    <option value="fishing">釣り</option>
</select>

<label>開始レベル：</label>
<input type="number" id="prodLvStart" min="1" value="1">

<label>終了レベル：</label>
<input type="number" id="prodLvEnd" min="1" value="1">

<label>1回で得られる経験値：</label>
<input type="number" id="prodExpPer" min="1" value="1">

<div id="materialInputs" style="margin-top:10px;"></div>

<button onclick="calcProd()">生産職を計算する</button>

<div id="prodSummary" style="margin-top:15px; font-size:18px;"></div>
<div class="table-wrapper"><div id="prodResult"></div></div>

<script>
/* ---- あなたの元コード（PWA対応にそのまま統合） ---- */

const ITEMS_PER_C = 1728;
let currentData = [];
let prodData = [];

function requiredExp(job, lv) {
    switch(job) {
        case "special": return 1 + 4*lv + lv*lv;
        case "first":   return 58 + 12*lv + 2*lv*lv;
        case "second":  return 2644 + 64*lv + 4*lv*lv;
        case "third":   return 4576 + 116*lv + 4*lv*lv;
    }
}

function setDefaultStartLevel() {
    const job = document.getElementById("job").value;
    let lvStartInput = document.getElementById("lvStart");
    switch(job){
        case "special": lvStartInput.value = 1; break;
        case "first":   lvStartInput.value = 1; break;
        case "second":  lvStartInput.value = 40; break;
        case "third":   lvStartInput.value = 60; break;
    }
}
document.getElementById("job").addEventListener("change", setDefaultStartLevel);
window.addEventListener("load", setDefaultStartLevel);

function calcTotal() {
    const job = document.getElementById("job").value;
    let lvStart = parseInt(document.getElementById("lvStart").value);
    let lvEnd   = parseInt(document.getElementById("lvEnd").value);
    const gain  = parseInt(document.getElementById("gain").value);
    const itemPerDelivery = parseInt(document.getElementById("itemPerDelivery").value);
    const perMinute = parseFloat(document.getElementById("perMinute").value);
    const maxLv = {special:220, first:100, second:150, third:180};

    if(lvStart < 1) lvStart = 1;
    if(lvEnd > maxLv[job]) lvEnd = maxLv[job];
    if(lvEnd < lvStart) { alert("終了レベルは開始レベル以上にしてください"); return; }

    currentData = [];
    let totalCount = 0;
    let totalItems = 0;

    for(let lv=lvStart; lv<=lvEnd; lv++){
        const req = requiredExp(job, lv);
        const eff = Math.min(req, gain);
        const count = Math.ceil(req / eff);
        const totalPerLevel = count * itemPerDelivery;
        totalCount += count;
        totalItems += totalPerLevel;
        currentData.push([lv, req, eff, count, totalPerLevel]);
    }

    const perHour = perMinute*60;
    let neededTimeMinutes = perMinute>0 ? totalItems/perMinute : 0;
    const hours = Math.floor(neededTimeMinutes/60);
    const minutes = Math.ceil(neededTimeMinutes%60);

    const cUnits = Math.floor(totalItems / ITEMS_PER_C);
    const remainder = totalItems % ITEMS_PER_C;

    document.getElementById("summary").innerHTML =
        `<b>累計納品回数: ${totalCount}</b><br>`+
        `<b>総必要個数: ${totalItems}</b><br>`+
        `<b>1C換算: ${cUnits}C + ${remainder}個</b><br>`+
        `<b>1時間で集められる素材量: ${perHour}</b><br>`+
        `<b>総必要時間: ${hours}時間 ${minutes}分</b>`;

    let html = `<table><tr><th>レベル</th><th>必要EXP</th><th>実効EXP</th><th>納品回数</th><th>必要個数</th></tr>`;
    currentData.forEach(row=>{html+=`<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td></tr>`});
    html += `</table>`;
    document.getElementById("result").innerHTML = html;
}

function requiredExpProd(job, lv){
    switch(job){
        case "weapon": return lv*lv + 2*lv + 1;
        case "armor": case "tool": case "alchemy": 
        case "mining": case "gathering": case "fishing":
            return lv*lv + 4*lv + 1;
    }
}

function updateMaterialInputs(){
    const job = document.getElementById("prodJob").value;
    const container = document.getElementById("materialInputs");
    container.innerHTML = "";
    if(job=="weapon"||job=="armor"||job=="tool"){
        container.innerHTML = `
            <label>素材1（1回あたり個数）:</label>
            <input type="number" id="mat1" min="0" value="1">
            <label>素材2（1回あたり個数）:</label>
            <input type="number" id="mat2" min="0" value="1">
        `;
    }else if(job=="alchemy"){
        container.innerHTML = `
            <label>素材1（1回あたり個数）:</label>
            <input type="number" id="mat1" min="0" value="1">
        `;
    }
}
document.getElementById("prodJob").addEventListener("change", updateMaterialInputs);
updateMaterialInputs();

function calcProd(){
    const job = document.getElementById("prodJob").value;
    let lvStart = parseInt(document.getElementById("prodLvStart").value);
    let lvEnd   = parseInt(document.getElementById("prodLvEnd").value);
    const expPer = parseInt(document.getElementById("prodExpPer").value);

    if(lvStart < 1) lvStart = 1;
    if(lvEnd > 200) lvEnd = 200;
    if(lvEnd < lvStart){ alert("終了レベルは開始レベル以上にしてください"); return; }

    let mat1 = 0, mat2 = 0;
    if(document.getElementById("mat1")) mat1 = parseInt(document.getElementById("mat1").value);
    if(document.getElementById("mat2")) mat2 = parseInt(document.getElementById("mat2").value);

    prodData = [];
    let totalCount = 0;
    let totalMat1 = 0;
    let totalMat2 = 0;

    for(let lv=lvStart; lv<=lvEnd; lv++){
        const req = requiredExpProd(job, lv);
        const count = Math.ceil(req / expPer);
        totalCount += count;
        totalMat1 += count*mat1;
        totalMat2 += count*mat2;
        prodData.push([lv, req, count, count*mat1, count*mat2]);
    }

    const cMat1 = Math.floor(totalMat1 / ITEMS_PER_C);
    const rMat1 = totalMat1 % ITEMS_PER_C;
    const cMat2 = Math.floor(totalMat2 / ITEMS_PER_C);
    const rMat2 = totalMat2 % ITEMS_PER_C;

    let summary = `<b>総必要作業回数: ${totalCount}</b><br>`;
    if(totalMat1>0) summary += `<b>素材1累計: ${totalMat1}個 (${cMat1}C + ${rMat1}個)</b><br>`;
    if(totalMat2>0) summary += `<b>素材2累計: ${totalMat2}個 (${cMat2}C + ${rMat2}個)</b><br>`;
    document.getElementById("prodSummary").innerHTML = summary;

    let html = `<table><tr><th>レベル</th><th>必要EXP</th><th>必要回数</th>`;
    if(totalMat1>0) html += `<th>素材1</th>`;
    if(totalMat2>0) html += `<th>素材2</th>`;
    html += `</tr>`;
    prodData.forEach(row=>{
        html += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
        if(totalMat1>0) html += `<td>${row[3]}</td>`;
        if(totalMat2>0) html += `<td>${row[4]}</td>`;
        html += `</tr>`;
    });
    html += `</table>`;
    document.getElementById("prodResult").innerHTML = html;
}

/* PWA service worker 登録 */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registered.'));
}
</script>

</body>
</html>
