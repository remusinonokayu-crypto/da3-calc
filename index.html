<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>DA3 çµŒé¨“å€¤è¨ˆç®—æ©Ÿ</title>

<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" href="icon.png">
<meta name="theme-color" content="#007bff">

<style>
/* ===== æ—¢å­˜ãƒ‡ã‚¶ã‚¤ãƒ³ãã®ã¾ã¾ ===== */
body {
    font-family: Arial, sans-serif;
    max-width: 900px;
    margin: 0 auto;
    padding: 15px;
    background: #f4f4f4;
}

label {
    margin-top: 12px;
    font-size: 16px;
    font-weight: bold;
    display: block;
}

select, input, button {
    width: 100%;
    font-size: 18px;
    padding: 12px;
    margin-top: 5px;
    box-sizing: border-box;
}

button {
    margin-top: 18px;
    background: #007bff;
    color: #fff;
    border: none;
    border-radius: 6px;
    font-size: 18px;
    padding: 14px;
}
button:hover {
    background: #005fcc;
}

h1, h2 {
    margin-top: 25px;
    text-align: center;
}

.table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-top: 10px;
    background: white;
    border-radius: 5px;
}

table {
    border-collapse: collapse;
    width: 100%;
    min-width: 600px;
    margin-top: 15px;
}
table, th, td {
    border: 1px solid #aaa;
}
th, td {
    padding: 6px;
    text-align: center;
}

@media (max-width: 600px) {
    body { padding: 10px; }
    h1 { font-size: 22px; }
    h2 { font-size: 20px; }
    select, input, button {
        font-size: 16px;
        padding: 10px;
    }
    label { font-size: 15px; }
}

/* ===== ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¯¾å¿œ ===== */
body.dark {
    background: #121212;
    color: #f0f0f0;
}

body.dark h1, body.dark h2 {
    color: #ffffff;
}

body.dark label {
    color: #e0e0e0;
}

body.dark input, 
body.dark select {
    background: #1e1e1e;
    color: #fff;
    border: 1px solid #555;
}

body.dark button {
    background: #333;
    color: #fff;
}

body.dark button:hover {
    background: #555;
}

body.dark .table-wrapper {
    background: #1e1e1e;
}

body.dark table {
    background: #1e1e1e;
    color: #fff;
}

body.dark th, 
body.dark td {
    border: 1px solid #555;
}
</style>
</head>

<body>

<button id="themeToggle" style="position:fixed; top:10px; right:10px; z-index:100;">
    ğŸŒ™ ãƒ€ãƒ¼ã‚¯
</button>

<h1>DA3 çµŒé¨“å€¤è¨ˆç®—æ©Ÿ</h1>

<!-- ===== æˆ¦é—˜è·è¨ˆç®— ===== -->
<h2>æˆ¦é—˜è·è¨ˆç®—</h2>

<label>è·æ¥­ï¼š</label>
<select id="job">
    <option value="special">ç‰¹æ®Š</option>
    <option value="first">ä¸€æ¬¡</option>
    <option value="second">äºŒæ¬¡</option>
    <option value="third">ä¸‰æ¬¡</option>
</select>

<label>é–‹å§‹ãƒ¬ãƒ™ãƒ«ï¼š</label>
<input type="number" id="lvStart" min="1" value="1">

<label>çµ‚äº†ãƒ¬ãƒ™ãƒ«ï¼š</label>
<input type="number" id="lvEnd" min="1" value="1">

<label>ç´å“EXPï¼ˆ1å›ã‚ãŸã‚Šï¼‰ï¼š</label>
<input type="number" id="gain" min="1" value="1">

<label>1å›ã®ç´å“ã§ä½¿ã†å¿…è¦å€‹æ•°ï¼š</label>
<input type="number" id="itemPerDelivery" min="1" value="1">

<label>1åˆ†é–“ã«å–ã‚Œã‚‹ç´ æé‡ï¼š</label>
<input type="number" id="perMinute" min="0" value="10">

<button onclick="calcTotal()">æˆ¦é—˜è·ã‚’è¨ˆç®—ã™ã‚‹</button>

<div id="summary" style="margin-top:15px; font-size:18px;"></div>
<div class="table-wrapper"><div id="result"></div></div>

<hr>

<!-- ===== ç”Ÿç”£è· ===== -->
<h2>ç”Ÿç”£è·è¨ˆç®—</h2>

<label>ç”Ÿç”£è·ï¼š</label>
<select id="prodJob">
    <option value="weapon">æ­¦å™¨</option>
    <option value="armor">é˜²å…·</option>
    <option value="tool">é“å…·</option>
    <option value="alchemy">éŒ¬é‡‘</option>
    <option value="mining">æ¡æ˜</option>
    <option value="gathering">æ¡å–</option>
    <option value="fishing">é‡£ã‚Š</option>
</select>

<label>é–‹å§‹ãƒ¬ãƒ™ãƒ«ï¼š</label>
<input type="number" id="prodLvStart" min="1" value="1">

<label>çµ‚äº†ãƒ¬ãƒ™ãƒ«ï¼š</label>
<input type="number" id="prodLvEnd" min="1" value="1">

<label>1å›ã§å¾—ã‚‰ã‚Œã‚‹çµŒé¨“å€¤ï¼š</label>
<input type="number" id="prodExpPer" min="1" value="1">

<div id="materialInputs" style="margin-top:10px;"></div>

<button onclick="calcProd()">ç”Ÿç”£è·ã‚’è¨ˆç®—ã™ã‚‹</button>

<div id="prodSummary" style="margin-top:15px; font-size:18px;"></div>
<div class="table-wrapper"><div id="prodResult"></div></div>

<hr>

<!-- ===== æ–°æ©Ÿèƒ½ï¼šç´å“å ±é…¬è¨ˆç®—ï¼ˆç·ã‚¢ã‚¤ãƒ†ãƒ æ•° â†’ ç´å“å›æ•°ï¼‰ ===== -->
<h2>ç´å“å ±é…¬è¨ˆç®—</h2>

<label>ç·ç´å“ã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼š</label>
<input type="number" id="bonusTotalItems" min="0" value="0">

<label>1å›ã®ç´å“ã§æ¶ˆè²»ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼š</label>
<input type="number" id="bonusItemPerDelivery" min="1" value="1">

<label>1å›ã®ç²å¾—EXPï¼š</label>
<input type="number" id="bonusExp" min="0" value="0">

<label>1å›ã®ç²å¾—GOLDï¼š</label>
<input type="number" id="bonusGold" min="0" value="0">

<h3>ç²å¾—ã‚¢ã‚¤ãƒ†ãƒ è¨­å®š</h3>

<label>ã‚¢ã‚¤ãƒ†ãƒ A åç§°</label>
<input type="text" id="itemAName" value="ã‚¢ã‚¤ãƒ†ãƒ A">
<label>1å›ã®ç²å¾—æ•°</label>
<input type="number" id="itemAPer" min="0" value="0">

<label>ã‚¢ã‚¤ãƒ†ãƒ B åç§°</label>
<input type="text" id="itemBName" value="ã‚¢ã‚¤ãƒ†ãƒ B">
<label>1å›ã®ç²å¾—æ•°</label>
<input type="number" id="itemBPer" min="0" value="0">

<label>ã‚¢ã‚¤ãƒ†ãƒ C åç§°</label>
<input type="text" id="itemCName" value="ã‚¢ã‚¤ãƒ†ãƒ C">
<label>1å›ã®ç²å¾—æ•°</label>
<input type="number" id="itemCPer" min="0" value="0">

<button onclick="calcBonus()">ç´å“å ±é…¬ã‚’è¨ˆç®—ã™ã‚‹</button>

<div id="bonusSummary" style="margin-top:15px; font-size:18px;"></div>
<div class="table-wrapper"><div id="bonusResult"></div></div>

<script>
/* ====================================
   ã“ã“ã‹ã‚‰ JavaScriptï¼ˆã‚ãªãŸã®å…ƒã‚³ãƒ¼ãƒ‰ + æ‹¡å¼µï¼‰
==================================== */

const ITEMS_PER_C = 1728;
let currentData = [];
let prodData = [];

/* ---- æˆ¦é—˜è·å¿…è¦EXP ---- */
function requiredExp(job, lv) {
    switch(job) {
        case "special": return 1 + 4*lv + lv*lv;
        case "first":   return 58 + 12*lv + 2*lv*lv;
        case "second":  return 2644 + 64*lv + 4*lv*lv;
        case "third":   return 4576 + 116*lv + 4*lv*lv;
    }
}

/* åˆæœŸãƒ¬ãƒ™ãƒ«è¨­å®š */
function setDefaultStartLevel() {
    const job = document.getElementById("job").value;
    let lvStartInput = document.getElementById("lvStart");
    switch(job){
        case "special": lvStartInput.value = 1; break;
        case "first":   lvStartInput.value = 1; break;
        case "second":  lvStartInput.value = 40; break;
        case "third":   lvStartInput.value = 60; break;
    }
}
document.getElementById("job").addEventListener("change", setDefaultStartLevel);
window.addEventListener("load", setDefaultStartLevel);

/* ---- æˆ¦é—˜è· è¨ˆç®— ---- */
function calcTotal() {
    const job = document.getElementById("job").value;
    let lvStart = parseInt(document.getElementById("lvStart").value);
    let lvEnd   = parseInt(document.getElementById("lvEnd").value);
    const gain  = parseInt(document.getElementById("gain").value);
    const itemPerDelivery = parseInt(document.getElementById("itemPerDelivery").value);
    const perMinute = parseFloat(document.getElementById("perMinute").value);
    const maxLv = {special:220, first:100, second:150, third:180};

    if(lvStart < 1) lvStart = 1;
    if(lvEnd > maxLv[job]) lvEnd = maxLv[job];
    if(lvEnd < lvStart) { alert("çµ‚äº†ãƒ¬ãƒ™ãƒ«ã¯é–‹å§‹ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã«ã—ã¦ãã ã•ã„"); return; }

    currentData = [];
    let totalCount = 0;
    let totalItems = 0;

    for(let lv=lvStart; lv<=lvEnd; lv++){
        const req = requiredExp(job, lv);
        const eff = Math.min(req, gain);
        const count = Math.ceil(req / eff);
        const totalPerLevel = count * itemPerDelivery;
        totalCount += count;
        totalItems += totalPerLevel;
        currentData.push([lv, req, eff, count, totalPerLevel]);
    }

    const perHour = perMinute*60;
    let neededTimeMinutes = perMinute>0 ? totalItems/perMinute : 0;
    const hours = Math.floor(neededTimeMinutes/60);
    const minutes = Math.ceil(neededTimeMinutes%60);

    const cUnits = Math.floor(totalItems / ITEMS_PER_C);
    const remainder = totalItems % ITEMS_PER_C;

    document.getElementById("summary").innerHTML =
        `<b>ç´¯è¨ˆç´å“å›æ•°: ${totalCount}</b><br>`+
        `<b>ç·å¿…è¦å€‹æ•°: ${totalItems}</b><br>`+
        `<b>1Cæ›ç®—: ${cUnits}C + ${remainder}å€‹</b><br>`+
        `<b>1æ™‚é–“ã§é›†ã‚ã‚‰ã‚Œã‚‹ç´ æé‡: ${perHour}</b><br>`+
        `<b>ç·å¿…è¦æ™‚é–“: ${hours}æ™‚é–“ ${minutes}åˆ†</b>`;

    let html = `<table><tr><th>ãƒ¬ãƒ™ãƒ«</th><th>å¿…è¦EXP</th><th>å®ŸåŠ¹EXP</th><th>ç´å“å›æ•°</th><th>å¿…è¦å€‹æ•°</th></tr>`;
    currentData.forEach(row=>{html+=`<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td><td>${row[3]}</td><td>${row[4]}</td></tr>`});
    html += `</table>`;
    document.getElementById("result").innerHTML = html;
}

/* ---- ç”Ÿç”£è· ---- */
function requiredExpProd(job, lv){
    switch(job){
        case "weapon": return lv*lv + 2*lv + 1;
        case "armor": case "tool": case "alchemy": 
        case "mining": case "gathering": case "fishing":
            return lv*lv + 4*lv + 1;
    }
}

function updateMaterialInputs(){
    const job = document.getElementById("prodJob").value;
    const container = document.getElementById("materialInputs");
    container.innerHTML = "";
    if(job=="weapon"||job=="armor"||job=="tool"){
        container.innerHTML = `
            <label>ç´ æ1ï¼ˆ1å›ã‚ãŸã‚Šå€‹æ•°ï¼‰:</label>
            <input type="number" id="mat1" min="0" value="1">
            <label>ç´ æ2ï¼ˆ1å›ã‚ãŸã‚Šå€‹æ•°ï¼‰:</label>
            <input type="number" id="mat2" min="0" value="1">
        `;
    }else if(job=="alchemy"){
        container.innerHTML = `
            <label>ç´ æ1ï¼ˆ1å›ã‚ãŸã‚Šå€‹æ•°ï¼‰:</label>
            <input type="number" id="mat1" min="0" value="1">
        `;
    }
}
document.getElementById("prodJob").addEventListener("change", updateMaterialInputs);
updateMaterialInputs();

/* ---- ç”Ÿç”£è·è¨ˆç®— ---- */
function calcProd(){
    const job = document.getElementById("prodJob").value;
    let lvStart = parseInt(document.getElementById("prodLvStart").value);
    let lvEnd   = parseInt(document.getElementById("prodLvEnd").value);
    const expPer = parseInt(document.getElementById("prodExpPer").value);

    if(lvStart < 1) lvStart = 1;
    if(lvEnd > 200) lvEnd = 200;
    if(lvEnd < lvStart){ alert("çµ‚äº†ãƒ¬ãƒ™ãƒ«ã¯é–‹å§‹ãƒ¬ãƒ™ãƒ«ä»¥ä¸Šã«ã—ã¦ãã ã•ã„"); return; }

    let mat1 = 0, mat2 = 0;
    if(document.getElementById("mat1")) mat1 = parseInt(document.getElementById("mat1").value);
    if(document.getElementById("mat2")) mat2 = parseInt(document.getElementById("mat2").value);

    prodData = [];
    let totalCount = 0;
    let totalMat1 = 0;
    let totalMat2 = 0;

    for(let lv=lvStart; lv<=lvEnd; lv++){
        const req = requiredExpProd(job, lv);
        const count = Math.ceil(req / expPer);
        totalCount += count;
        totalMat1 += count*mat1;
        totalMat2 += count*mat2;
        prodData.push([lv, req, count, count*mat1, count*mat2]);
    }

    const cMat1 = Math.floor(totalMat1 / ITEMS_PER_C);
    const rMat1 = totalMat1 % ITEMS_PER_C;
    const cMat2 = Math.floor(totalMat2 / ITEMS_PER_C);
    const rMat2 = totalMat2 % ITEMS_PER_C;

    let summary = `<b>ç·å¿…è¦ä½œæ¥­å›æ•°: ${totalCount}</b><br>`;
    if(totalMat1>0) summary += `<b>ç´ æ1ç´¯è¨ˆ: ${totalMat1}å€‹ (${cMat1}C + ${rMat1}å€‹)</b><br>`;
    if(totalMat2>0) summary += `<b>ç´ æ2ç´¯è¨ˆ: ${totalMat2}å€‹ (${cMat2}C + ${rMat2}å€‹)</b><br>`;
    document.getElementById("prodSummary").innerHTML = summary;

    let html = `<table><tr><th>ãƒ¬ãƒ™ãƒ«</th><th>å¿…è¦EXP</th><th>å¿…è¦å›æ•°</th>`;
    if(totalMat1>0) html += `<th>ç´ æ1</th>`;
    if(totalMat2>0) html += `<th>ç´ æ2</th>`;
    html += `</tr>`;
    prodData.forEach(row=>{
        html += `<tr><td>${row[0]}</td><td>${row[1]}</td><td>${row[2]}</td>`;
        if(totalMat1>0) html += `<td>${row[3]}</td>`;
        if(totalMat2>0) html += `<td>${row[4]}</td>`;
        html += `</tr>`;
    });
    html += `</table>`;
    document.getElementById("prodResult").innerHTML = html;
}

/* ---------------------------------
   æ–°æ©Ÿèƒ½ï¼šç·ã‚¢ã‚¤ãƒ†ãƒ æ•° â†’ ç´å“å›æ•°
--------------------------------- */
function calcBonus() {

    const totalItems = parseInt(document.getElementById("bonusTotalItems").value);
    const itemPerDelivery = parseInt(document.getElementById("bonusItemPerDelivery").value);

    if (itemPerDelivery <= 0) {
        alert("1å›ã®ç´å“ã§æ¶ˆè²»ã™ã‚‹ã‚¢ã‚¤ãƒ†ãƒ æ•°ã¯ 1 ä»¥ä¸Šã«ã—ã¦ãã ã•ã„ã€‚");
        return;
    }

    // ç´å“å›æ•° = ç·ã‚¢ã‚¤ãƒ†ãƒ æ•° Ã· æ¶ˆè²»é‡
    const deliveryCount = Math.floor(totalItems / itemPerDelivery);

    // 1å›ã‚ãŸã‚Š
    const expPer = parseInt(document.getElementById("bonusExp").value);
    const goldPer = parseInt(document.getElementById("bonusGold").value);

    const nameA = document.getElementById("itemAName").value;
    const nameB = document.getElementById("itemBName").value;
    const nameC = document.getElementById("itemCName").value;

    const aPer = parseInt(document.getElementById("itemAPer").value);
    const bPer = parseInt(document.getElementById("itemBPer").value);
    const cPer = parseInt(document.getElementById("itemCPer").value);

    // åˆè¨ˆ
    const totalExp = deliveryCount * expPer;
    const totalGold = deliveryCount * goldPer;

    const totalA = deliveryCount * aPer;
    const totalB = deliveryCount * bPer;
    const totalC = deliveryCount * cPer;

    // Cæ›ç®—
    function toC(num) {
        return `${Math.floor(num / ITEMS_PER_C)}C + ${num % ITEMS_PER_C}å€‹`;
    }

    // å‡ºåŠ›
    let summary = `
        <b>ç·ç´å“ã‚¢ã‚¤ãƒ†ãƒ æ•°ï¼š${totalItems}</b><br>
        <b>1å›ã®æ¶ˆè²»ï¼š${itemPerDelivery}å€‹</b><br>
        <b>â†’ ç´å“å›æ•°ï¼š${deliveryCount}å›</b><br><br>

        <b>ç·ç²å¾—EXPï¼š${totalExp}</b><br>
        <b>ç·ç²å¾—GOLDï¼š${totalGold}</b><br>
    `;

    if (aPer > 0) summary += `<b>${nameA}ï¼š${totalA}å€‹ï¼ˆ${toC(totalA)}ï¼‰</b><br>`;
    if (bPer > 0) summary += `<b>${nameB}ï¼š${totalB}å€‹ï¼ˆ${toC(totalB)}ï¼‰</b><br>`;
    if (cPer > 0) summary += `<b>${nameC}ï¼š${totalC}å€‹ï¼ˆ${toC(totalC)}ï¼‰</b><br>`;

    document.getElementById("bonusSummary").innerHTML = summary;

    // è¡¨
    let html = `<table>
        <tr><th>é …ç›®</th><th>åˆè¨ˆ</th><th>1Cæ›ç®—</th></tr>
        <tr><td>ç´å“å›æ•°</td><td>${deliveryCount}</td><td>-</td></tr>
        <tr><td>EXP</td><td>${totalExp}</td><td>-</td></tr>
        <tr><td>GOLD</td><td>${totalGold}</td><td>-</td></tr>
    `;

    if (aPer > 0) html += `<tr><td>${nameA}</td><td>${totalA}</td><td>${toC(totalA)}</td></tr>`;
    if (bPer > 0) html += `<tr><td>${nameB}</td><td>${totalB}</td><td>${toC(totalB)}</td></tr>`;
    if (cPer > 0) html += `<tr><td>${nameC}</td><td>${totalC}</td><td>${toC(totalC)}</td></tr>`;

    html += `</table>`;

    document.getElementById("bonusResult").innerHTML = html;
}

/* ---- PWA ---- */
if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
        .then(() => console.log('Service Worker registered.'));
}

/* ---- ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ ---- */
const savedTheme = localStorage.getItem("theme");
if (savedTheme === "dark") {
    document.body.classList.add("dark");
    document.getElementById("themeToggle").textContent = "â˜€ ãƒ©ã‚¤ãƒˆ";
}

document.getElementById("themeToggle").addEventListener("click", () => {
    document.body.classList.toggle("dark");
    const isDark = document.body.classList.contains("dark");
    document.getElementById("themeToggle").textContent = isDark ? "â˜€ ãƒ©ã‚¤ãƒˆ" : "ğŸŒ™ ãƒ€ãƒ¼ã‚¯";
    localStorage.setItem("theme", isDark ? "dark" : "light");
});
</script>

</body>
</html>


