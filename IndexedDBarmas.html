<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>é˜²å…·ãƒ‡ãƒ¼ã‚¿ç®¡ç† (IndexedDBç‰ˆ)</title>

<style>
  :root{
    --bg:#ffffff; --text:#000000; --panel:#f6f6f6; --border:#ccc; --accent:#4a8;
  }
  body.dark{
    --bg:#1e1e1e; --text:#e8e8e8; --panel:#2b2b2b; --border:#444; --accent:#5ca;
  }
  body{
    background:var(--bg); color:var(--text); font-family: sans-serif;
    padding:18px; transition:background .2s, color .2s;
  }

  h2{margin-top:0}
  select,input{background:var(--panel); color:var(--text); border:1px solid var(--border); padding:6px; margin:4px 0;}
  button{padding:6px 10px; margin-left:6px; cursor:pointer; border-radius:6px; border:1px solid var(--border); background:transparent; color:var(--text);}
  .toggle-btn{background:var(--accent); color:#fff; border:none; padding:6px 10px; border-radius:6px;}
  .section{margin-bottom:18px}
  .result-box{padding:8px; border:1px solid var(--border); margin:6px 0; background:var(--panel); display:flex; justify-content:space-between; align-items:center;}
  .delete-btn{background:#d44; color:#fff; border:none; padding:6px 8px; border-radius:6px; cursor:pointer;}
  .fold-header{display:flex; justify-content:space-between; align-items:center; background:var(--panel); padding:8px; border:1px solid var(--border); margin-top:8px; border-radius:6px; cursor:pointer;}
  .fold-content{padding:6px 10px; border:1px solid var(--border); border-top:none; margin-bottom:10px; background:transparent;}
  .small{font-size:0.9rem}
  .muted{color:rgba(0,0,0,0.5)}
  .search{width:60%; padding:6px}
  .inline{display:inline-block; vertical-align:middle}
  @media (max-width:640px){
    .search{width:100%}
  }
</style>

<!-- Dexie.js (IndexedDB ãƒ©ãƒƒãƒ‘ãƒ¼) -->
<script src="https://cdn.jsdelivr.net/npm/dexie@3.2.3/dist/dexie.min.js"></script>
</head>
<body>
<h2>é˜²å…·ãƒ‡ãƒ¼ã‚¿ç®¡ç†</h2>
<button onclick="location.href='index.html'">ãƒ›ãƒ¼ãƒ ã¸ç§»å‹•</button>
<label><input type="checkbox" id="darkToggle"> ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰</label>

<hr>

<!-- å…¥åŠ› -->
<div class="section">
  <button class="toggle-btn" onclick="toggleSection('inputWrap')">â–¼ é¸æŠã‚¨ãƒªã‚¢</button>
  <div id="inputWrap" style="margin-top:8px"></div>
</div>

<!-- ã‚½ãƒ¼ãƒˆ -->
<div class="section">
  <button class="toggle-btn" onclick="toggleSection('sortWrap')">â–¼ ã‚½ãƒ¼ãƒˆæ¡ä»¶</button>
  <div id="sortWrap" style="margin-top:8px"></div>
  <div style="margin-top:8px;">
    <button onclick="sortData()">ã‚½ãƒ¼ãƒˆå®Ÿè¡Œ</button>
  </div>
</div>

<h3>ã‚½ãƒ¼ãƒˆçµæœ</h3>
<div id="sortResult"></div>

<hr>

<h3>ä¿å­˜ã•ã‚Œã¦ã„ã‚‹å…¨ãƒ‡ãƒ¼ã‚¿</h3>
<div id="allList"></div>

<script>
/* ---------------------------
   OPTIONS (ãã®ã¾ã¾ç¶­æŒ)
   --------------------------- */
const OPTIONS = {
  towns: [
    "ãƒ¬ãƒãƒ­æ‘",
    "ãƒã‚¯ãƒ«ãƒ€ç”º",
    "ãƒ«ãƒ¼ãƒã‚§ã‚¢ç”º",
    "ã‚½ãƒ«ã‚½ãƒ­ç‹å›½",
    "ã‚µãƒ—ãƒãƒ©ç‹å›½",
    "ã‚»ã‚·ãƒ‰ç”º"
  ],

  armorName: {
    "ãƒ¬ãƒãƒ­æ‘": ["çµ¹", "æ¨¹çš®"],
    "ãƒã‚¯ãƒ«ãƒ€ç”º": ["éª¨", "æ£®æ—"],
    "ãƒ«ãƒ¼ãƒã‚§ã‚¢ç”º": ["é­”çŸ³", "è‰ç²˜é­”"],
    "ã‚½ãƒ«ã‚½ãƒ­ç‹å›½": ["ç ‚å¡µ", "è–é¨å£«"],
    "ã‚µãƒ—ãƒãƒ©ç‹å›½": ["å…‰ç ‚", "ç´…ç‰"],
    "ã‚»ã‚·ãƒ‰ç”º": ["ç‚ç‰™", "ä¹¾æ³¥"]
  },

  type: ["é‡‘å±", "å¸ƒ", "çš®"],

  part: ["é ­", "èƒ´ä½“", "è¶³"],

  times: ["1","2","3","4","5","6","7","8","9","10","11","12","13","14"],

  power: {
    "é ­": ["ä½“åŠ›", "ç²¾ç¥", "å®ˆå‚™åŠ›"],
    "èƒ´ä½“": ["åŠ›", "é­”åŠ›", "å®ˆå‚™åŠ›"],
    "è¶³": ["ç´ æ—©ã•", "æ’ƒåŠ›", "å®ˆå‚™åŠ›"]
  },

  ex: ["ä½“åŠ›", "åŠ›", "ç²¾ç¥", "ç´ æ—©ã•", "æ’ƒåŠ›", "å™¨ç”¨ã•"]
};

/* =================================================
   IndexedDB åˆæœŸåŒ– (Dexie)
   - items: å„é˜²å…·ãƒ¬ã‚³ãƒ¼ãƒ‰ï¼ˆid è‡ªå‹•ï¼‰
   - settings: ã‚­ãƒ¼ã¨å€¤ã®ä¿å­˜ï¼ˆãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ç­‰ï¼‰
================================================= */
const db = new Dexie("ArmorDB_v1");
db.version(1).stores({
  items: "++id, town, armorName",   // ä¸»ã« town ã§æ¤œç´¢
  settings: "&key"                  // key ã‚’ä¸€æ„ã«
});

/* =================================================
   armorData = { town: [ itemObj, ... ], ... }
   itemObj ã¯ { id, town, armorName, type, part, times, power, ex1, ex2 }
   ï¼ˆå…ƒã®æ©Ÿæ§‹ã‚’å£Šã•ãªã„ãŸã‚ãƒ¡ãƒ¢ãƒªä¸Šã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’ä½¿ã„ã¾ã™ï¼‰
================================================= */
let armorData = {};
OPTIONS.towns.forEach(t => armorData[t] = []);

/* ---------------------------
   ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰å¾©å…ƒï¼ˆIndexedDB ã¸ç§»è¡Œï¼‰
   --------------------------- */
async function initDarkModeFromDB(){
  try {
    const row = await db.settings.get("darkMode");
    const saved = row ? row.value : "light";
    document.body.classList.toggle("dark", saved === "dark");
    document.getElementById("darkToggle").checked = saved === "dark";
  } catch(e) {
    // ç„¡è¦–ã—ã¦ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆ
  }

  document.getElementById("darkToggle").addEventListener("change", async () => {
    const isDark = document.getElementById("darkToggle").checked;
    document.body.classList.toggle("dark", isDark);
    try {
      await db.settings.put({ key: "darkMode", value: isDark ? "dark" : "light" });
    } catch(e) {
      console.error("settings ä¿å­˜ã‚¨ãƒ©ãƒ¼:", e);
    }
  });
}

/* ---------------------------
   ãƒ˜ãƒ«ãƒ‘ãƒ¼ï¼ˆselectç”Ÿæˆãªã©ï¼‰
   --------------------------- */
function createSelectHTML(id, arr, addBlank=false){
  let s = `<select id="${id}">`;
  if (addBlank) s += `<option value="">æŒ‡å®šãªã—</option>`;
  arr.forEach(v => s += `<option value="${v}">${v}</option>`);
  s += `</select>`;
  return s;
}

function toggleSection(id){
  const el = document.getElementById(id);
  el.style.display = el.style.display === "none" ? "block" : "none";
}

/* ---------------------------
   å…¥åŠ›ã‚¨ãƒªã‚¢æ§‹ç¯‰ï¼ˆæ—¢å­˜æ©Ÿæ§‹ã‚’å£Šã•ãªã„ï¼‰
   --------------------------- */
function buildInputArea(){
  const html = `
    ç”ºï¼š${createSelectHTML("town", OPTIONS.towns)} <br>
    é˜²å…·åï¼š<select id="armorName"></select><br>
    ç¨®é¡ï¼š${createSelectHTML("type", OPTIONS.type)}<br>
    éƒ¨ä½ï¼š${createSelectHTML("part", OPTIONS.part)}<br>
    å©ãå›æ•°ï¼š${createSelectHTML("times", OPTIONS.times)}<br>
    å©ãèƒ½åŠ›å€¤ï¼š<select id="power"></select><br>
    EX1ï¼š${createSelectHTML("ex1", OPTIONS.ex)} EX2ï¼š${createSelectHTML("ex2", OPTIONS.ex)}<br>
    <button onclick="saveData()">ä¿å­˜</button>
  `;
  const wrap = document.getElementById("inputWrap");
  wrap.innerHTML = html;

  // town/part ã®å¤‰æ›´ã«å¿œã˜ã¦é˜²å…·åãƒ»èƒ½åŠ›å€¤æ›´æ–°
  document.getElementById("town").addEventListener("change", updateArmorName);
  document.getElementById("part").addEventListener("change", updatePower);

  // åˆæœŸå€¤ã‚»ãƒƒãƒˆ
  updateArmorName();
  updatePower();
}

function updateArmorName(){
  const t = document.getElementById("town").value;
  const box = document.getElementById("armorName");
  box.innerHTML = OPTIONS.armorName[t].map(v => `<option value="${v}">${v}</option>`).join("");
}

function updatePower(){
  const p = document.getElementById("part").value;
  const box = document.getElementById("power");
  box.innerHTML = (OPTIONS.power[p]||[]).map(v => `<option value="${v}">${v}</option>`).join("");
}

/* ---------------------------
   ã‚½ãƒ¼ãƒˆã‚¨ãƒªã‚¢æ§‹ç¯‰ï¼ˆç”ºæŒ‡å®šã§é˜²å…·åãƒ»powerã‚‚çµã‚Œã‚‹ï¼‰
   --------------------------- */
function buildSortArea(){
  const html = `
    ç”ºï¼š${createSelectHTML("sTown", OPTIONS.towns, true)}<br>
    é˜²å…·åï¼š<select id="sArmorName"><option value="">æŒ‡å®šãªã—</option></select><br>
    ç¨®é¡ï¼š${createSelectHTML("sType", OPTIONS.type, true)}<br>
    éƒ¨ä½ï¼š${createSelectHTML("sPart", OPTIONS.part, true)}<br>
    å©ãå›æ•°ï¼š${createSelectHTML("sTimes", OPTIONS.times, true)}<br>
    å©ãèƒ½åŠ›å€¤ï¼š<select id="sPower"><option value="">æŒ‡å®šãªã—</option></select><br>
    EX1ï¼š${createSelectHTML("sEx1", OPTIONS.ex, true)} EX2ï¼š${createSelectHTML("sEx2", OPTIONS.ex, true)}<br><br>
    ğŸ”å…¨æ–‡æ¤œç´¢ï¼š <input id="sortSearch" class="search" placeholder="ä¾‹ï¼šé‰„ã€å®ˆå‚™ã€UP ãªã©">
  `;
  const wrap = document.getElementById("sortWrap");
  wrap.innerHTML = html;

  document.getElementById("sTown").addEventListener("change", updateSortArmorName);
  document.getElementById("sPart").addEventListener("change", updateSortPower);
}

function updateSortArmorName(){
  const t = document.getElementById("sTown").value;
  const box = document.getElementById("sArmorName");
  if (!t){ box.innerHTML = `<option value="">æŒ‡å®šãªã—</option>`; return; }
  box.innerHTML = `<option value="">æŒ‡å®šãªã—</option>` + OPTIONS.armorName[t].map(v => `<option value="${v}">${v}</option>`).join("");
}

function updateSortPower(){
  const p = document.getElementById("sPart").value;
  const box = document.getElementById("sPower");
  if (!p){ box.innerHTML = `<option value="">æŒ‡å®šãªã—</option>`; return; }
  box.innerHTML = `<option value="">æŒ‡å®šãªã—</option>` + (OPTIONS.power[p]||[]).map(v=>`<option value="${v}">${v}</option>`).join("");
}

/* ---------------------------
   IndexedDB â†” armorData åŒæœŸå‡¦ç†
   --------------------------- */

/* IndexedDB â†’ armorDataï¼ˆåˆæœŸãƒ­ãƒ¼ãƒ‰ï¼‰ */
async function loadArmorData(){
  try {
    const rows = await db.items.toArray();
    // åˆæœŸåŒ–
    OPTIONS.towns.forEach(t => armorData[t] = []);
    // å–ã‚Šè¾¼ã¿
    rows.forEach(row => {
      const t = row.town;
      if (!armorData[t]) armorData[t] = [];
      armorData[t].push({
        id: row.id,
        town: row.town,
        armorName: row.armorName,
        type: row.type,
        part: row.part,
        times: row.times,
        power: row.power,
        ex1: row.ex1,
        ex2: row.ex2
      });
    });
  } catch(e) {
    console.error("loadArmorData ã‚¨ãƒ©ãƒ¼:", e);
    // ç©ºåˆæœŸåŒ–
    OPTIONS.towns.forEach(t => armorData[t] = []);
  }
}

/* IndexedDB ã«ä¿å­˜ï¼ˆä¿å­˜å…ƒã¯ UI ã® inputï¼‰ */
async function saveData(){
  const t = document.getElementById("town").value;
  const item = {
    town: t,
    armorName: document.getElementById("armorName").value,
    type: document.getElementById("type").value,
    part: document.getElementById("part").value,
    times: document.getElementById("times").value,
    power: document.getElementById("power").value,
    ex1: document.getElementById("ex1").value,
    ex2: document.getElementById("ex2").value
  };

  try {
    const id = await db.items.add(item);
    item.id = id;
    // ãƒ¡ãƒ¢ãƒªã‚­ãƒ£ãƒƒã‚·ãƒ¥ã«è¿½åŠ 
    if (!armorData[t]) armorData[t] = [];
    armorData[t].push(item);

    drawAll();
    sortData();
    alert("ä¿å­˜ã—ã¾ã—ãŸï¼ˆIndexedDBï¼‰");
  } catch(e) {
    console.error("saveData ã‚¨ãƒ©ãƒ¼:", e);
    alert("ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: " + e.message);
  }
}

/* IndexedDB ã‹ã‚‰å‰Šé™¤ï¼ˆid å˜ä½ï¼‰ ã¨ armorData ã‹ã‚‰å‰Šé™¤ */
async function deleteItem(town, index){
  if (!confirm("å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ")) return;
  const item = armorData[town][index];
  if (!item) return;

  try {
    await db.items.delete(item.id);
  } catch(e) {
    console.error("DBå‰Šé™¤ã‚¨ãƒ©ãƒ¼:", e);
    alert("å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ");
    return;
  }

  armorData[town].splice(index,1);
  drawAll();
  sortData();
}

/* ---------------------------
   drawAll(): ç”ºåˆ¥ æŠ˜ã‚ŠãŸãŸã¿ä»˜ãã§è¡¨ç¤º
   ï¼ˆUI æ©Ÿæ§‹ã¯å…ƒã®ã¾ã¾ï¼‰
   --------------------------- */
function drawAll(){
  const out = document.getElementById("allList");
  out.innerHTML = "";

  OPTIONS.towns.forEach((town, ti) => {
    // è¦‹å‡ºã—ï¼ˆæŠ˜ã‚ŠãŸãŸã¿ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ï¼‰
    const header = document.createElement("div");
    header.className = "fold-header";
    header.id = `all-header-${town}`;

    const left = document.createElement("div");
    left.innerHTML = `<strong>${town}</strong> <span class="muted small">(${armorData[town].length}ä»¶)</span>`;
    header.appendChild(left);

    const btn = document.createElement("button");
    btn.textContent = "å±•é–‹";
    btn.onclick = () => {
      const content = document.getElementById(`all-content-${town}`);
      const showing = content.style.display !== "none";
      content.style.display = showing ? "none" : "block";
      btn.textContent = showing ? "å±•é–‹" : "æŠ˜ç•³";
    };
    header.appendChild(btn);

    out.appendChild(header);

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    const content = document.createElement("div");
    content.className = "fold-content";
    content.id = `all-content-${town}`;
    content.style.display = "none";

    if (!armorData[town] || armorData[town].length === 0) {
      const empty = document.createElement("div");
      empty.className = "result-box";
      empty.textContent = "ï¼ˆãƒ‡ãƒ¼ã‚¿ãªã—ï¼‰";
      content.appendChild(empty);
    } else {
      armorData[town].forEach((d, i) => {
        const row = document.createElement("div");
        row.className = "result-box";
        row.innerHTML = `
          <div class="small">${i}. ${d.armorName} / ${d.type} / ${d.part} / ${d.times}å› / ${d.power} / EX:${d.ex1}, ${d.ex2}</div>
          <div><button class="delete-btn" onclick="deleteItem('${town}', ${i})">å‰Šé™¤</button></div>
        `;
        content.appendChild(row);
      });
    }

    out.appendChild(content);
  });
}

/* ---------------------------
   sortData(): ç”ºã”ã¨åˆ†ã‘ã¦è¡¨ç¤ºï¼ˆå®Œå…¨ä¸€è‡´ç³»æ¡ä»¶ + å…¨æ–‡æ¤œç´¢ï¼‰
   --------------------------- */
function sortData(){
  const cond = {
    town: document.getElementById("sTown") ? document.getElementById("sTown").value : "",
    armorName: document.getElementById("sArmorName") ? document.getElementById("sArmorName").value : "",
    type: document.getElementById("sType") ? document.getElementById("sType").value : "",
    part: document.getElementById("sPart") ? document.getElementById("sPart").value : "",
    times: document.getElementById("sTimes") ? document.getElementById("sTimes").value : "",
    power: document.getElementById("sPower") ? document.getElementById("sPower").value : "",
    ex1: document.getElementById("sEx1") ? document.getElementById("sEx1").value : "",
    ex2: document.getElementById("sEx2") ? document.getElementById("sEx2").value : "",
    keyword: document.getElementById("sortSearch") ? document.getElementById("sortSearch").value.trim().toLowerCase() : ""
  };

  const out = document.getElementById("sortResult");
  out.innerHTML = "";

  OPTIONS.towns.forEach((town) => {
    // ç”ºã§çµã‚‹å ´åˆã¯å¯¾è±¡ç”ºã®ã¿å‡¦ç†ï¼ˆãŸã ã— cond.town ãŒç©ºãªã‚‰å…¨éƒ¨ï¼‰
    if (cond.town && cond.town !== town) return;

    const matches = (armorData[town] || []).filter(d => {
      // å®Œå…¨ä¸€è‡´ãƒ•ã‚£ãƒ«ã‚¿
      if (cond.armorName && d.armorName !== cond.armorName) return false;
      if (cond.type && d.type !== cond.type) return false;
      if (cond.part && d.part !== cond.part) return false;
      if (cond.times && d.times !== cond.times) return false;
      if (cond.power && d.power !== cond.power) return false;
      if (cond.ex1 && d.ex1 !== cond.ex1) return false;
      if (cond.ex2 && d.ex2 !== cond.ex2) return false;

      // å…¨æ–‡æ¤œç´¢ï¼ˆä»»æ„ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ï¼‰
      if (cond.keyword) {
        const hay = [d.town, d.armorName, d.type, d.part, d.times, d.power, d.ex1, d.ex2].join(" ").toLowerCase();
        if (!hay.includes(cond.keyword)) return false;
      }
      return true;
    });

    // ç”ºã®ãƒ˜ãƒƒãƒ€
    const header = document.createElement("div");
    header.className = "fold-header";
    header.innerHTML = `<div><strong>${town}</strong> <span class="muted small">(${matches.length}ä»¶)</span></div>`;
    // å±•é–‹ãƒœã‚¿ãƒ³
    const btn = document.createElement("button");
    btn.textContent = "å±•é–‹";
    let contentId = `sort-content-${town}`;
    btn.onclick = () => {
      const c = document.getElementById(contentId);
      const showing = c.style.display !== "none";
      c.style.display = showing ? "none" : "block";
      btn.textContent = showing ? "å±•é–‹" : "æŠ˜ç•³";
    };
    header.appendChild(btn);

    out.appendChild(header);

    // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„
    const content = document.createElement("div");
    content.className = "fold-content";
    content.id = contentId;
    content.style.display = "block";

    if (matches.length === 0) {
      const none = document.createElement("div");
      none.className = "result-box";
      none.textContent = "ï¼ˆè©²å½“ãªã—ï¼‰";
      content.appendChild(none);
    } else {
      matches.forEach((d, i) => {
        // index in armorData[town] for delete
        const idx = armorData[town].indexOf(d);
        const row = document.createElement("div");
        row.className = "result-box";
        row.innerHTML = `
          <div class="small">${idx}. ${d.armorName} / ${d.type} / ${d.part} / ${d.times}å› / ${d.power} / EX:${d.ex1}, ${d.ex2}</div>
          <div><button class="delete-btn" onclick="deleteItem('${town}', ${idx})">å‰Šé™¤</button></div>
        `;
        content.appendChild(row);
      });
    }

    out.appendChild(content);
  });
}

/* ---------------------------
   åˆæœŸåŒ–ï¼ˆãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ï¼‰
   - IndexedDB ã‹ã‚‰èª­ã¿è¾¼ã‚“ã§ armorData ã‚’æ§‹ç¯‰
   - UI ã‚’ç”Ÿæˆã—ã¦è¡¨ç¤ºï¼ˆå…ƒã®å‹•ä½œé †åºã‚’ç¶­æŒï¼‰
   --------------------------- */
async function initAll(){
  await initDarkModeFromDB();
  await loadArmorData();
  buildInputArea();
  buildSortArea();
  drawAll();
  sortData();
}

/* ãƒšãƒ¼ã‚¸ãƒ­ãƒ¼ãƒ‰ã§èµ·å‹• */
window.addEventListener("DOMContentLoaded", initAll);

</script>
</body>
</html>
